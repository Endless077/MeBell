--Creazione tabelle
create table utente(nickname char(15) primary key, nome varchar(25) not null, cognome varchar(25) not null, password varchar(15) not null );
create table recensione(voto int not null, testo varchar(250), creatore char(15) not null, cod_locale char(10) not null );
create table location(cod char(10) primary key, nome varchar(25) not null, cod_res char(5) not null, tipo_location varchar(25), check (tipo_location='Alloggio' OR tipo_location='Attrazione' OR tipo_location='Ristorante' ), partita_iva char(11), descrizione varchar(100) );

create table residenza(via varchar(25) not null, n_civico char(3) not null, cap char(5) not null, comune varchar(25) not null, cod_residenza char(5) primary key );

create table alloggio(cod char(10) not null, n_camere smallint, n_suite smallint, stelle smallint, tipo_alloggio varchar(25), check(tipo_alloggio='Hotel' OR  tipo_alloggio='BEB' OR  tipo_alloggio='Appartamento' ));
create table servizi_alloggio(cod char(10), wi_fi char(1) default 'n', spa char(1) default 'n', piscina char(1) default 'n', aria_condizionata char(1) default 'n', accesso_disabili char(1) default 'n', accesso_animali char(1) default 'n', ascensore char(1) default 'n', servizio_lavanderia char(1) default 'n', tv_stereo char(1) default 'n', parcheggio char(1) default 'n' );

create table attrazione(cod char(10), pagamento char(1) default 'n', tipo_attrazione varchar(25) );

create table ristorante(cod char(10), n_posti smallint, tipo_cucina varchar(25), check(tipo_cucina='Fusion' OR tipo_cucina='Orientale' OR tipo_cucina='Occidentale') );
create table servizi_ristorante(cod char(10), fast_food char(1) default 'n', pizzeria char(1) default 'n', braceria char(1) default 'n', birreria char(1) default 'n', pub char(1) default 'n', diner char(1) default 'n', bar char(1) default 'n' );

--Unique
alter table recensione add constraint uc_recensione unique (creatore,cod_locale);

alter table alloggio add constraint uc_cod_all unique(cod);
alter table ristorante add constraint uc_cod_rist unique(cod);
alter table attrazione add constraint uc_cod_att unique(cod);

--Foreign key
alter table recensione add constraint fk_recensione_creatore foreign key (creatore) references utente(nickname) ON DELETE CASCADE;
alter table recensione add constraint fk_recensione_cod_locale foreign key (cod_locale) references location(cod) ON DELETE CASCADE;

alter table location add constraint fk_residenza_cod_residenza foreign key (cod_res) references residenza(cod_residenza);

alter table alloggio add constraint fk_alloggio foreign key (cod) references location(cod) ON DELETE CASCADE;
alter table attrazione add constraint fk_attrazione foreign key (cod) references location(cod) ON DELETE CASCADE;
alter table ristorante add constraint fk_ristorante foreign key (cod) references location(cod) ON DELETE CASCADE;

alter table servizi_alloggio add constraint fk_servizi_alloggio foreign key (cod) references alloggio(cod) ON DELETE CASCADE;
alter table attrazione add constraint tipo_attrazione check(tipo_attrazione='Chiesa' OR tipo_attrazione='Museo' OR tipo_attrazione='Parco' OR tipo_attrazione='Monumento' OR tipo_attrazione='Parco Giochi' OR tipo_attrazione='Centro Sportivo' OR tipo_attrazione='Teatro' OR tipo_attrazione='Cinema' OR tipo_attrazione='Acquario' OR tipo_attrazione='Zona Balneare' OR tipo_attrazione='Zoo');
alter table servizi_ristorante add constraint fk_servizi_ristorazione foreign key (cod) references ristorante(cod) ON DELETE CASCADE;

--TRIGGER
create trigger update_utente
  after update of nickname on utente
  for each row 

begin 

   update recensione r
   set r.creatore=:new.nickname 
   where r.creatore=:old.nickname;

END;

--

create trigger update_cod_locale
  after update of cod on location
  for each row 
  
Declare
tipo VARCHAR2(25):='';

begin 
  update recensione r
  set r.cod_locale=:new.cod 
  where r.cod_locale=:old.cod;
  
  select tipo_location into tipo from location l where l.cod=:old.cod;
  
IF tipo='Attrazione'  THEN

    update attrazione a
    set a.cod=:new.cod
    where a.cod=:old.cod;

ELSIF tipo='Alloggio' THEN

    update alloggio al
    set al.cod=:new.cod
    where al.cod=:old.cod;

ELSE

   update ristorante ri
   set ri.cod=:new.cod
   where ri.cod=:old.cod;

END IF;

END;

--

create trigger update_cod_residenza
  after update of cod_residenza on residenza
  for each row

begin

   update location l
   set l.cod_res=:new.cod_residenza
   where l.cod_res=:old.cod_residenza;

END;

--

create trigger update_servizi_ristorante
  after update of cod on ristorante
  for each row 

begin 

   update servizi_ristorante sr
   set sr.cod=:new.cod 
   where sr.cod=:old.cod;

END;

--

create trigger update_sevizi_alloggio
  after update of cod on alloggio
  for each row 

begin 

   update servizi_alloggio sa
   set sa.cod=:new.cod 
   where sa.cod=:old.cod;

END;